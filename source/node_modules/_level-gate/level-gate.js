'use strict'
var string2es6tl = require('es6-template-strings')
var minixhr = require('minixhr')
/******************************************************************************
  MAIN

  VISION:

  // DATA SOURCE MAPPING
  // have spec for HTTP, WebSocket, WebRTC, Static (file watch?) sources
  // to map to db_keys

  // DATA SINK MAPPING
  // have spec for db_keys to ... static, e.g. write to file

  // USAGE
    var gate = dataGate(_dataSourceMapping, _dataSinkMapping)
    gate.pipe(db).pipe(gate)

******************************************************************************/
module.exports = levelgate

// @TODO: maybe use "duplexify" to set datasourcemapping and datasinkmapping later at runtime or even "change it" :-)
function levelgate (datasourcemapping, datasinkmapping) {
  var DB

  // MOCK API
  var gate = {
    pipe: function (db) {
      DB = db
      wirein(datasourcemapping, DB)
      return {
        pipe: function (writestream) {
          if (writestream !== gate) {
            throw new Error('pipe to real stream not supported yet')
          } else {
            wireout(datasinkmapping, db)
          }
        }
      }
    }
  }
  return gate
}
// HELPER
function wirein (datasourcemapping, db) {
  // CONTROL is a multiplex signal to "modulate" the streams language

  // var CONTROL = 'rs'
  var CONTROL = 'en'

  var https = Object.keys(datasourcemapping.HTTPS)
  https.map(function(template) {
    return 'https://' + string2es6tl(template, { lang: CONTROL })
  }).forEach(function (source, idx) {
    // @TODO:check cache first before making request to github
    // @TODO: use ETag
    minixhr(source, function (json) {
      var mappings = datasourcemapping.HTTPS[https[idx]]
      var data = JSON.parse(json)
      Object.keys(mappings).forEach(function (key) {
        var petkey = mappings[key]
        var value = data[key]
        db.put(petkey, value, function (error) {
          if (error) console.error('couldnt store value')
        })
      })
    })
  })
}
function wireout(datasinkmapping, db) {
  db.on('put', function (key, value) {
    console.log('::::::::::::::::::::::::::::::::::::::::::')
    console.log('var value = ' + value)
    console.log('[GATE] db.put("'+key+'", value)')
    console.log('::::::::::::::::::::::::::::::::::::::::::')
  })
  db.on('batch', function () {
    console.log('::::::::::::::::::::::::::::::::::::::::::')
    console.log('[GATE] db.batch(...)')
    console.log(arguments)
    console.log('::::::::::::::::::::::::::::::::::::::::::')
  })
  db.on('get', function () {
    console.log('::::::::::::::::::::::::::::::::::::::::::')
    console.log('[GATE] db.get(...)')
    console.log(arguments)
    console.log('::::::::::::::::::::::::::::::::::::::::::')
  })
  db.on('del', function () {
    console.log('::::::::::::::::::::::::::::::::::::::::::')
    console.log('[GATE] db.del(...)')
    console.log(arguments)
    console.log('::::::::::::::::::::::::::::::::::::::::::')
  })
}
